<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Story Jadwal Cuti Dokter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        #story-preview {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(160deg, #192670, #4c9b32);
            color: white;
            width: 1080px;
            height: 1920px;
            transform-origin: top left;
        }
        .montserrat {
            font-family: 'Montserrat', sans-serif;
        }
        #doctor-checkbox-list::-webkit-scrollbar { width: 8px; }
        #doctor-checkbox-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #doctor-checkbox-list::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #doctor-checkbox-list::-webkit-scrollbar-thumb:hover { background: #555; }
        #story-preview img {
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col md:flex-row h-screen overflow-hidden">

    <div class="w-full md:w-1/3 lg:w-1/4 bg-white p-6 shadow-lg overflow-y-auto">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Desain Story Cuti</h1>
            <p class="text-gray-500">Buat gambar jadwal cuti untuk Instagram Story.</p>
        </div>
        
        <div id="loading-state" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuat data dari Google Sheets...</p>
        </div>

        <div id="controls" class="hidden space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Dokter Cuti</label>
                <div id="doctor-checkbox-list" class="w-full p-3 border border-gray-300 rounded-lg max-h-60 overflow-y-auto space-y-2">
                </div>
            </div>
            
            <div>
                <label for="logo-url" class="block text-sm font-medium text-gray-700 mb-1">URL Logo</label>
                <input type="text" id="logo-url" value="asset/logo/logo.png" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="https://.../logo.png">
                 <p class="text-xs text-gray-500 mt-1">Gunakan logo dari file `index.html` atau ganti URL.</p>
            </div>
            
            <div>
                <label for="background-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Tema Background</label>
                <select id="background-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    <option value="gradient-blue" selected>Biru & Hijau (Default)</option>
                    <option value="gradient-purple">Ungu & Pink</option>
                    <option value="gradient-orange">Oranye & Kuning</option>
                    <option value="solid-white">Putih Solid</option>
                </select>
            </div>

            <div class="pt-4">
                <button id="download-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg disabled:bg-gray-400" disabled>
                    <span>Generate via API</span>
                </button>
            </div>
        </div>
        
        <div id="error-state" class="hidden text-center py-8 bg-red-50 border-l-4 border-red-400 p-4">
            <p class="font-bold text-red-800">Gagal Memuat Data</p>
            <p class="text-red-600 text-sm">Tidak bisa mengambil data dokter atau jadwal cuti. Periksa kembali koneksi dan URL API Google Sheets Anda.</p>
        </div>
    </div>

    <div class="flex-grow bg-gray-100 flex items-center justify-center p-4 overflow-hidden">
        <div id="preview-container" class="w-full h-full">
            <div id="story-preview" class="flex flex-col p-16">
                <div class="flex-shrink-0 flex justify-center items-center">
                    <img id="story-logo" src="asset/logo/logo.png" class="h-28" alt="Logo">
                </div>

                <div class="flex-grow flex flex-col justify-start items-center text-center pt-20">
                    <div class="mb-12">
                        <p class="text-5xl tracking-widest montserrat">PEMBERITAHUAN</p>
                        <h2 class="text-9xl font-extrabold mt-2 montserrat">JADWAL CUTI</h2>
                    </div>
                    
                    <div id="story-doctors-list" class="w-full flex flex-col items-center justify-center flex-grow space-y-8 px-12">
                        <div class="text-center text-4xl opacity-75 flex flex-col justify-center items-center h-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mb-4 text-white/50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                            </svg>
                            <p>Pilih dokter dari panel kiri untuk melihat preview.</p>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 text-center">
                    <p class="text-3xl font-semibold">Informasi lebih lanjut, hubungi kami.</p>
                </div>
            </div>
        </div>
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // URL dan path tetap sama
        const GOOGLE_SCRIPT_JADWAL_URL = 'https://script.google.com/macros/s/AKfycbw6Fz5vI992Xya34JAkwMRY4oD1opCoBiWTQpPoTNSe9F_b5IdbI-ydtNix2AOj0IgyDg/exec';
        const GOOGLE_SCRIPT_CUTI_URL = 'https://script.google.com/macros/s/AKfycbxEp7OwCT0M9Zak1XYeSu4rjkQTjoD-qgh8INEW5btIVVNv15i1DnzI3RUwmLoqG9TtSQ/exec';
        const LOCAL_WEBP_IMAGE_PATH = 'Asset/webp/';
        
        // ==========================================================
        // DIHAPUS: URL CORS Proxy tidak lagi diperlukan
        // ==========================================================

        const controls = document.getElementById('controls');
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const doctorCheckboxList = document.getElementById('doctor-checkbox-list');
        const logoUrlInput = document.getElementById('logo-url');
        const backgroundSelect = document.getElementById('background-select');
        const storyPreview = document.getElementById('story-preview');
        const storyLogo = document.getElementById('story-logo');
        const downloadButton = document.getElementById('download-button');
        
        let combinedData = [];

        // Fungsi fetch data tidak berubah
        async function fetchData(url) {
            try {
                const response = await fetch(`${url}?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Network response was not ok for ${url}`);
                return await response.json();
            } catch (error) {
                console.error('Fetch error:', error);
                showError();
                return null;
            }
        }
        
        function showError() {
            loadingState.style.display = 'none';
            controls.style.display = 'none';
            errorState.style.display = 'block';
        }
        
        // Fungsi utilitas tanggal tidak berubah
        function formatFullDate(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
            return `${day} ${months[month]} ${year}`;
        }

        // Fungsi untuk mendapatkan ID dokter yang dipilih tidak berubah
        function getSelectedDoctorIds() {
            const selectedDoctors = [];
            const checkboxes = doctorCheckboxList.querySelectorAll('input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedDoctors.push(checkbox.value);
            });
            return selectedDoctors;
        }

        // Fungsi update preview disederhanakan, tidak perlu lagi mengatur state tombol download
        function updateStoryPreview(doctorIds) {
            const doctorsListContainer = document.getElementById('story-doctors-list');
            
            if (!doctorIds || doctorIds.length === 0) {
                doctorsListContainer.innerHTML = `
                    <div class="text-center text-4xl opacity-75 flex flex-col justify-center items-center h-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mb-4 text-white/50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                        </svg>
                        <p>Pilih dokter dari panel kiri untuk melihat preview.</p>
                    </div>`;
                downloadButton.disabled = true;
                return;
            }

            const selectedDoctorsData = doctorIds.map(id => combinedData.find(d => d.id === id)).filter(Boolean);
            let doctorHTML = '';
            const numDoctors = selectedDoctorsData.length;
            
            // Logika penyesuaian ukuran tetap sama, ini bagian dari desain
            let containerClass = "w-full flex flex-col items-center justify-center flex-grow space-y-8 px-12";
            let itemClass = "flex items-center w-full bg-white/20 rounded-3xl p-8 shadow-lg";
            let photoClass = "w-48 h-48 rounded-full object-cover border-8 border-white flex-shrink-0";
            let textContainerClass = "ml-8 text-left";
            let nameClass = "text-5xl font-bold";
            let specialtyClass = "text-3xl opacity-90 mt-1";
            let dateClass = "text-3xl mt-4";

            if (numDoctors > 2) {
                containerClass = "w-full flex flex-col items-center justify-center flex-grow space-y-6 px-10";
                itemClass = "flex items-center w-full bg-white/20 rounded-3xl p-6 shadow-lg";
                photoClass = "w-40 h-40 rounded-full object-cover border-8 border-white flex-shrink-0";
                textContainerClass = "ml-6 text-left";
                nameClass = "text-4xl font-bold";
                specialtyClass = "text-2xl opacity-90 mt-1";
                dateClass = "text-2xl mt-3";
            }
            if (numDoctors > 4) {
                containerClass = "w-full flex flex-col items-center justify-center flex-grow space-y-4 px-8";
                itemClass = "flex items-center w-full bg-white/20 rounded-2xl p-4 shadow-lg";
                photoClass = "w-32 h-32 rounded-full object-cover border-4 border-white flex-shrink-0";
                textContainerClass = "ml-4 text-left";
                nameClass = "text-3xl font-bold";
                specialtyClass = "text-xl opacity-90";
                dateClass = "text-xl mt-2";
            }

            doctorsListContainer.className = containerClass;

            selectedDoctorsData.forEach(doctor => {
                const startDate = formatFullDate(doctor.cutiMulai);
                const endDate = formatFullDate(doctor.cutiSelesai);
                const leaveDatesText = (startDate === endDate) ? startDate : `${startDate} - ${endDate}`;
                
                doctorHTML += `
                    <div class="${itemClass}">
                        <img src="${doctor.fotourl}" class="${photoClass}" alt="Foto ${doctor.nama}" onerror="this.src='https://placehold.co/200x200/ffffff/cccccc?text=Error'">
                        <div class="${textContainerClass}">
                            <h3 class="${nameClass}">${doctor.nama}</h3>
                            <p class="${specialtyClass}">${doctor.spesialis}</p>
                            <p class="${dateClass}">Tidak praktek: <strong class="font-semibold">${leaveDatesText}</strong></p>
                        </div>
                    </div>`;
            });
            
            doctorsListContainer.innerHTML = doctorHTML;
            downloadButton.disabled = false;
        }
        
        // Fungsi update background tidak berubah
        function updateBackground(theme) {
            storyPreview.style.background = '';
            storyPreview.style.color = 'white';

            switch(theme) {
                case 'gradient-purple':
                    storyPreview.style.background = 'linear-gradient(160deg, #5a189a, #c1121f, #f77f00)';
                    break;
                case 'gradient-orange':
                    storyPreview.style.background = 'linear-gradient(160deg, #f7b267, #f79d65, #f4845f)';
                    break;
                case 'solid-white':
                    storyPreview.style.background = 'white';
                    storyPreview.style.color = '#374151';
                    break;
                case 'gradient-blue':
                default:
                    storyPreview.style.background = 'linear-gradient(160deg, #192670, #4c9b32)';
                    break;
            }
        }
        
        // ==========================================================
        // DIHAPUS: Semua fungsi terkait konversi gambar dan download
        // (toDataURL, waitForImagesToLoad, ensureLogoDataUrl, downloadStory)
        // ==========================================================

        // Fungsi inisialisasi tidak berubah banyak, hanya lebih sederhana
        async function initialize() {
            const [jadwalData, cutiData] = await Promise.all([
                fetchData(GOOGLE_SCRIPT_JADWAL_URL),
                fetchData(GOOGLE_SCRIPT_CUTI_URL)
            ]);

            if (!jadwalData || !cutiData) return;

            const allDoctors = [];
            for (const key in jadwalData) {
                jadwalData[key].doctors.forEach(doc => {
                    const imageName = doc.image_webp ? doc.image_webp.split(/[\\/]/).pop() : '';
                    allDoctors.push({
                        nama: doc.name,
                        spesialis: jadwalData[key].title,
                        fotourl: imageName ? LOCAL_WEBP_IMAGE_PATH + encodeURIComponent(imageName) : 'https://placehold.co/200x200/ffffff/cccccc?text=Foto'
                    });
                });
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            combinedData = cutiData
                .map((cuti, index) => {
                    const endDateParts = cuti.TanggalSelesaiCuti.split('-');
                    if(endDateParts.length !== 3) return null;
                    const endDate = new Date(endDateParts[2], endDateParts[1]-1, endDateParts[0]);
                    
                    if (endDate < today) return null;

                    const doctorDetails = allDoctors.find(d => d.nama.toLowerCase() === cuti.NamaDokter.toLowerCase());
                    return {
                        id: `doc-${index}`,
                        nama: cuti.NamaDokter,
                        cutiMulai: cuti.TanggalMulaiCuti,
                        cutiSelesai: cuti.TanggalSelesaiCuti,
                        spesialis: doctorDetails ? doctorDetails.spesialis : 'Spesialis tidak ditemukan',
                        fotourl: doctorDetails ? doctorDetails.fotourl : 'https://placehold.co/200x200/ffffff/cccccc?text=Foto'
                    };
                })
                .filter(Boolean);

            if (combinedData.length > 0) {
                doctorCheckboxList.innerHTML = '';
                combinedData.forEach(doc => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center';
                    div.innerHTML = `
                        <input id="${doc.id}" type="checkbox" value="${doc.id}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                        <label for="${doc.id}" class="ml-3 block text-sm font-medium text-gray-700 cursor-pointer">${doc.nama} (Cuti s/d ${formatFullDate(doc.cutiSelesai)})</label>
                    `;
                    doctorCheckboxList.appendChild(div);
                });
            } else {
                 doctorCheckboxList.innerHTML = '<p class="text-sm text-gray-500">Tidak ada jadwal cuti dokter yang akan datang.</p>';
            }
            
            loadingState.style.display = 'none';
            controls.style.display = 'block';

            // Menyesuaikan ukuran preview saat pertama kali dimuat
            const previewContainer = document.getElementById('preview-container');
            const scale = Math.min(
                previewContainer.clientWidth / 1080,
                previewContainer.clientHeight / 1920
            );
            storyPreview.style.transform = `scale(${scale})`;
        }

        // EVENT LISTENERS
        doctorCheckboxList.addEventListener('change', () => {
            const selectedIds = getSelectedDoctorIds();
            updateStoryPreview(selectedIds);
        });
        
        logoUrlInput.addEventListener('change', (e) => {
            storyLogo.src = e.target.value;
        });

        backgroundSelect.addEventListener('change', (e) => updateBackground(e.target.value));

        // Panggil fungsi utama
        initialize();
        
        // Event listener untuk resize window tetap berguna untuk preview
        window.addEventListener('resize', () => {
             const previewContainer = document.getElementById('preview-container');
             const scale = Math.min(
                previewContainer.clientWidth / 1080,
                previewContainer.clientHeight / 1920
            );
            storyPreview.style.transform = `scale(${scale})`;
        });
    });
</script>
</body>
</html>