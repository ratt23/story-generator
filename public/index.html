<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Story Jadwal Cuti Dokter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        #story-preview {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(160deg, #192670, #4c9b32);
            color: white;
            width: 1080px;
            height: 1920px;
            /* Perubahan 1: Mengubah titik acuan scaling ke tengah untuk stabilitas */
            transform-origin: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease-in-out, background 0.3s, color 0.3s;
        }
        .montserrat { font-family: 'Montserrat', sans-serif; }
        #doctor-checkbox-list::-webkit-scrollbar { width: 8px; }
        #doctor-checkbox-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #doctor-checkbox-list::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        #doctor-checkbox-list::-webkit-scrollbar-thumb:hover { background: #555; }
        #story-preview img { object-fit: cover; }
        #story-preview .flex .items-center img.rounded-full { object-position: center 10%; }
        #dot-pattern-overlay {
            background-image: radial-gradient(circle, #000080 1px, transparent 1px);
            background-size: 15px 15px; opacity: 0.05; z-index: 0; pointer-events: none;
        }
    </style>
</head>
<body class="bg-slate-100 flex flex-col md:flex-row md:h-screen md:overflow-hidden">

    <div class="w-full md:w-1/3 lg:w-1/4 bg-white p-6 shadow-lg md:overflow-y-auto flex-shrink-0 border-b md:border-b-0 md:border-r border-slate-200">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-slate-800">Desain Story Cuti</h1>
            <p class="text-slate-500">Gunakan panel ini untuk membuat gambar jadwal cuti.</p>
        </div>
        <div id="loading-state" class="text-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-slate-600">Memuat data dari Google Sheets...</p>
        </div>
        <div id="controls" class="hidden space-y-6">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Pilih Dokter Cuti</label>
                <div id="doctor-checkbox-list" class="w-full p-3 border border-slate-300 rounded-lg max-h-60 overflow-y-auto space-y-2"></div>
            </div>
            <div>
                <label for="logo-url" class="block text-sm font-medium text-slate-700 mb-1">URL Logo (Opsional)</label>
                <input type="text" id="logo-url" placeholder="Biarkan kosong untuk logo default" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="background-select" class="block text-sm font-medium text-slate-700 mb-1">Pilih Tema Background</label>
                <select id="background-select" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="gradient-blue" selected>Biru & Hijau (Default)</option>
                    <option value="gradient-purple">Ungu & Pink</option>
                    <option value="gradient-orange">Oranye & Kuning</option>
                    <option value="solid-white">Putih Solid</option>
                </select>
            </div>
            <div class="pt-4">
                <button id="download-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors">
                    <span id="button-text">Pilih Dokter Dahulu</span>
                </button>
            </div>
        </div>
        <div id="error-state" class="hidden text-center py-8 bg-red-50 border-l-4 border-red-400 p-4">
            <p class="font-bold text-red-800">Gagal Memuat Data</p>
            <p class="text-sm text-red-600">Coba muat ulang halaman atau periksa koneksi internet.</p>
        </div>
    </div>

    <div class="flex-grow bg-slate-100 flex items-center justify-center py-10 md:p-4">
        <div id="preview-container" class="w-full h-full flex items-center justify-center">
            <div id="story-preview" class="flex flex-col p-16 shadow-2xl">
                <div id="dot-pattern-overlay" class="absolute inset-0 hidden"></div>
                <div class="flex-shrink-0 flex justify-center items-center relative z-10">
                    <img id="story-logo" src="asset/logo/logo.png" class="h-28" alt="Logo">
                </div>
                <div class="flex-grow flex flex-col justify-start items-center text-center pt-20 relative z-10">
                    <div class="mb-12">
                        <p class="text-5xl tracking-widest montserrat">PEMBERITAHUAN</p>
                        <h2 class="text-9xl font-extrabold mt-2 montserrat">CUTI DOKTER</h2>
                    </div>
                    <div id="story-doctors-list" class="w-full flex flex-col items-center justify-center flex-grow space-y-6 px-12 relative z-10">
                        </div>
                </div>
                <div class="flex-shrink-0 text-center relative z-10">
                    <p class="text-3xl font-semibold">Siloam Hospitals Ambon</p>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // URL, Elemen DOM, dan Variabel Global
    const GOOGLE_SCRIPT_JADWAL_URL = 'https://script.google.com/macros/s/AKfycbw6Fz5vI992Xya34JAkwMRY4oD1opCoBiWTQpPoTNSe9F_b5IdbI-ydtNix2AOj0IgyDg/exec';
    const GOOGLE_SCRIPT_CUTI_URL = 'https://script.google.com/macros/s/AKfycbxEp7OwCT0M9Zak1XYeSu4rjkQTjoD-qgh8INEW5btIVVNv15i1DnzI3RUwmLoqG9TtSQ/exec';
    const LOCAL_WEBP_IMAGE_PATH = 'asset/webp/';
    const controls = document.getElementById('controls');
    const loadingState = document.getElementById('loading-state');
    const doctorCheckboxList = document.getElementById('doctor-checkbox-list');
    const downloadButton = document.getElementById('download-button');
    const buttonText = document.getElementById('button-text');
    const backgroundSelect = document.getElementById('background-select');
    const storyLogo = document.getElementById('story-logo');
    let allCutiData = [];

    // --- FUNGSI-FUNGSI ---

    function resizePreview() {
        const previewContainer = document.getElementById('preview-container');
        const storyPreview = document.getElementById('story-preview');
        if (!previewContainer || !storyPreview) return;
        
        const scale = (window.innerWidth >= 768)
            ? Math.min(previewContainer.clientWidth / 1080, previewContainer.clientHeight / 1920)
            : previewContainer.clientWidth / 1080;
        
        storyPreview.style.transform = `scale(${scale * 0.92})`;
        // Perubahan 2: Hapus baris di bawah ini agar menggunakan setting dari CSS saja
        // storyPreview.style.transformOrigin = 'top center'; // <-- HAPUS BARIS INI
    }

    function getSelectedDoctorIds() {
        return Array.from(document.querySelectorAll('#doctor-checkbox-list input:checked')).map(cb => cb.value);
    }
    
    function updateDoctorPreview() {
        const doctorsListContainer = document.getElementById('story-doctors-list');
        const selectedIds = getSelectedDoctorIds();
        if (selectedIds.length === 0) {
            doctorsListContainer.innerHTML = `<div class="text-center text-4xl opacity-75 flex flex-col justify-center items-center h-full"><p>Pilih dokter dari panel kiri untuk melihat preview.</p></div>`;
            return;
        }
        const selectedDoctors = selectedIds.map(id => allCutiData.find(d => d.id === id)).filter(Boolean);
        let doctorHTML = '';
        selectedDoctors.forEach(doctor => {
            const leaveDatesText = (doctor.cutiMulai === doctor.cutiSelesai)
                ? formatFullDate(doctor.cutiMulai)
                : `${formatFullDate(doctor.cutiMulai)} - ${formatFullDate(doctor.cutiSelesai)}`;
            const isLightTheme = backgroundSelect.value === 'solid-white';
            const cardClass = isLightTheme 
                ? 'bg-slate-100 text-slate-800 border border-slate-200'
                : 'bg-white/20 text-white';
            doctorHTML += `
                <div class="flex items-center w-full rounded-2xl p-4 shadow-md ${cardClass}">
                    <img src="${doctor.fotourl}" class="w-24 h-24 rounded-full object-cover border-4 border-white flex-shrink-0" alt="Foto ${doctor.nama}" onerror="this.src='https://placehold.co/200x200/e2e8f0/475569?text=No+Photo'">
                    <div class="ml-4 text-left">
                        <h3 class="text-2xl font-bold">${doctor.nama}</h3>
                        <p class="text-lg opacity-90">${doctor.spesialis}</p>
                        <p class="text-lg mt-1"><strong class="font-semibold">${leaveDatesText}</strong></p>
                    </div>
                </div>`;
        });
        doctorsListContainer.innerHTML = doctorHTML;
    }

    function updateUiState() {
        const selectedIds = getSelectedDoctorIds();
        if (selectedIds.length > 0) {
            downloadButton.disabled = false;
            buttonText.textContent = `Generate & Download (${selectedIds.length} Dokter)`;
        } else {
            downloadButton.disabled = true;
            buttonText.textContent = 'Pilih Dokter Dahulu';
        }
        updateDoctorPreview();
    }

    function updateBackgroundPreview(theme) {
        const storyPreview = document.getElementById('story-preview');
        const dotPatternOverlay = document.getElementById('dot-pattern-overlay');
        storyPreview.style.background = '';
        storyPreview.style.color = 'white';
        dotPatternOverlay.classList.add('hidden');
        switch(theme) {
            case 'gradient-purple': storyPreview.style.background = 'linear-gradient(160deg, #5a189a, #c1121f, #f77f00)'; break;
            case 'gradient-orange': storyPreview.style.background = 'linear-gradient(160deg, #f7b267, #f79d65, #f4845f)'; break;
            case 'solid-white': 
                storyPreview.style.background = 'white'; 
                storyPreview.style.color = '#1e293b';
                dotPatternOverlay.classList.remove('hidden');
                break;
            default: storyPreview.style.background = 'linear-gradient(160deg, #192670, #4c9b32)'; break;
        }
        updateDoctorPreview();
    }

    function generateAndDownload() {
        const params = new URLSearchParams();
        params.append('doctors', getSelectedDoctorIds().join(','));
        params.append('theme', backgroundSelect.value);
        if (document.getElementById('logo-url').value) {
            params.append('logo', document.getElementById('logo-url').value);
        }
        window.open(`/.netlify/functions/generate-story?${params.toString()}`, '_blank');
    }
    
    async function fetchData(url) {
        try {
            const response = await fetch(`${url}?t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Network error`);
            return await response.json();
        } catch (error) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            return null;
        }
    }
    
    function formatFullDate(dateStr) {
        if (!dateStr) return '';
        const [day, month, year] = dateStr.split('-');
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'];
        return `${parseInt(day, 10)} ${months[parseInt(month, 10) - 1]} ${year}`;
    }

    async function initialize() {
        const [jadwalData, cutiData] = await Promise.all([
            fetchData(GOOGLE_SCRIPT_JADWAL_URL),
            fetchData(GOOGLE_SCRIPT_CUTI_URL)
        ]);
        if (!jadwalData || !cutiData) return;
        const allDoctors = new Map();
        for (const key in jadwalData) {
            jadwalData[key].doctors.forEach(doc => {
                const imageName = doc.image_webp ? doc.image_webp.split(/[\\/]/).pop() : '';
                allDoctors.set(doc.name.toLowerCase(), {
                    spesialis: jadwalData[key].title,
                    fotourl: imageName ? LOCAL_WEBP_IMAGE_PATH + encodeURIComponent(imageName) : 'https://placehold.co/200x200/e2e8f0/475569?text=No+Photo'
                });
            });
        }
        const today = new Date(); today.setHours(0, 0, 0, 0);
        allCutiData = cutiData.map((cuti, index) => {
            const endDateParts = cuti.TanggalSelesaiCuti.split('-');
            if (endDateParts.length !== 3) return null;
            const endDate = new Date(endDateParts[2], endDateParts[1] - 1, endDateParts[0]);
            if (endDate < today) return null;
            const details = allDoctors.get(cuti.NamaDokter.toLowerCase());
            return {
                id: `doc-${index}`,
                nama: cuti.NamaDokter,
                cutiMulai: cuti.TanggalMulaiCuti,
                cutiSelesai: cuti.TanggalSelesaiCuti,
                spesialis: details ? details.spesialis : 'N/A',
                fotourl: details ? details.fotourl : 'https://placehold.co/200x200/e2e8f0/475569?text=No+Photo'
            };
        }).filter(Boolean);
        if (allCutiData.length > 0) {
            doctorCheckboxList.innerHTML = '';
            allCutiData.forEach(doc => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input id="${doc.id}" type="checkbox" value="${doc.id}" class="h-4 w-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500 cursor-pointer">
                    <label for="${doc.id}" class="ml-3 block text-sm font-medium text-slate-700 cursor-pointer">${doc.nama} (Cuti s/d ${formatFullDate(doc.cutiSelesai)})</label>
                `;
                doctorCheckboxList.appendChild(div);
            });
        } else {
            doctorCheckboxList.innerHTML = '<p class="text-sm text-slate-500">Tidak ada jadwal cuti dokter.</p>';
        }
        loadingState.style.display = 'none';
        controls.style.display = 'block';
        updateDoctorPreview();
        resizePreview();
    }

    // EVENT LISTENERS
    doctorCheckboxList.addEventListener('change', updateUiState);
    backgroundSelect.addEventListener('change', (e) => updateBackgroundPreview(e.target.value));
    document.getElementById('logo-url').addEventListener('input', (e) => {
        storyLogo.src = e.target.value || 'asset/logo/logo.png';
    });
    downloadButton.addEventListener('click', generateAndDownload);
    window.addEventListener('resize', resizePreview);
    
    initialize();
});
</script>
</body>
</html>